NodeJS随笔
--------------------

个人比较看好的Node.js应用场景有

1. 工具类
2. 服务聚合胶水层
3. UI接入层

工具类的应用场景目前已经取得了很大的成绩，因此略过不提。

## 服务聚合胶水层

这一层更加推荐RD参与来做这个事情，利用Node.js的高并发与异步能力，我们可以将原有的API进行聚合封装，如果这个胶水层是直接与C Server对接，在快速开发能力上拥有和PHP一样的效率，而在性能方面，Node.js至少更加容易实现高并发与异步请求。当然在这方面，我并不认为Node.js比go或者erlang会有多大的优势，但是的确是可行的。

## UI接入层

### 收益

#### 架构升级

更全面的接管后端模版渲染工作，推动后端服务化，利于独立架构升级。为何一直到Node.js解决方案，FIS才能真正意义上的实现Bigpipe，这就是因为后端模版渲染工作受限于后端开发人员，需要很强的推动和执行能力才能把Bigpipe推广成功，但是在Node.js解决方案中，通过对后端模版渲染层的全面控制，进行这个架构升级毫无阻力。

#### 加快开发

通过Node.js层的介入，我们可以对数据有组合调整能力，很多需求变更不再依赖后端开发，减少前后端沟通成本。此外，由于后端服务的解耦，前端的提测环境可以更加简单与独立，提测环境的简化，更利于前端全流程的打通。

#### 性能提升

我并不赞同Node.js的性能提升只是跑分上的提升，如Paypal的案例 https://www.paypal-engineering.com/2013/11/22/node-js-at-paypal/ 对于real world application，也是有绝对的提升的。

### 技术选型

遗憾的是并非只有使用Node.js才能实现。比如划分PHPUI层，我们一样可以完全解耦前后端，拥有独立的架构升级、加快开发，甚至性能上，PHP也可以通过hhvm和php-ng以及异步请求支撑。

因此这个问题到这里，实际上是一个UI层**技术选型**的问题。

以技术方面的思路总结的话，作为UI层的技术选型，PHP的确更容易让小白FE写出稳定的后端UI层代码，但是对于大部分FE，使用Node.js更容易并且更自然的实现类似Bigpipe以及异步API请求。

从项目推动上来看，hhvm和php-ng以及PHP异步请求这些技术来看，想要在PHPUI层推动应用这些技术，绝非是几个FE或者RD就能HOLD住的，不得不说，Node.js绝对是一条性能提升和架构升级的捷径。

Node.js的问题则是目前有很多的坑，但是我认为并不是无法处理的。

### 坑

Node.js有坑，不过也不能过于放大，个人认为最主要的几点有

#### 内存泄露

内存泄露的主要原因还是全局变量以及闭包变量使用上的问题，如果FE以浏览器端的思维来编写后端逻辑，的确容易出现问题。但是主要还是代码编写上导致的问题，与C++不同，Node.js得内存泄露绝大部分还是在v8管理下的内存泄露，并不是对系统资源的内存泄露，我们可以有多种方式来排查处理这个问题。即使是PHP，也是会有内存泄露问题的，这是值得注意的问题，但是不是解决不了的问题。

#### HTTP请求缺乏Context

无法拿到单一HTTP请求的上下文，如果很多资源可以绑定在Context中，随着请求销毁，那么在内存泄露上的问题实际上可以减少很多。并且缺乏Context导致我们即使想要实现单请求的全局变量需求，比如LogID，都会十分困难。

注：没有Context不是内存泄露的直接原因，而是会让开发人员产生全局变量绑定或闭包变量的依赖。如果单纯使用req或者res来绑定，不利于Model层的实现。

#### 异步请求与错误处理

这里不多说了，说多了都是泪，只能寄希望于v 0.12以及类库封装。

### 总结
 
想要解决Node.js的UI接入层的坑，我认为整体思路就是做的越少，错的越少。。

UI层一定要薄，业务逻辑必须少到极致，只有获取数据-组织数据-模版渲染的内容。

每个请求，都应该尽可能的减少FE使用回调函数的次数，目前只有一个大概的思路，即组件与数据模型绑定，数据模型与服务绑定，将重试以及错误处理都交由类库来处理。

使用这样的解决方案，只要解决方案的质量过硬，牺牲了部分灵活性，但是带来了API重试机制保证系统稳定，详尽的错误日志用于分析，大量减少回调处理，UI层出现问题的几率也大大减少。

此外，关于Node.js的部署、监控问题，我的观点是，Node.js并不复杂，之所以大家认为很麻烦，原因主要在于

1. 即使是PHP、Nginx等环境部署，第一次做的时候也会很麻烦，即使是在厂里，线上机也能只直接运行Node.js的预编译版本
2. 大部分FE对服务器部署不了解，在没有OP、RD支持下，这个事情的确很难开展

因此未来UI层的全流程打通势必会包括部署、运维一体化内容，帮助FE建立UI层，不用再趟我们趟过的坑。
